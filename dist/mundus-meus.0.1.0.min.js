/*! MundusMeus by Adam Timberlake created on 2013-07-23 */
"use strict";function GeolocationCtrl($scope,$http,$interpolate,$timeout,$mundusMeus){var URL_GEOLOCATE="./../api/Geolocate/{{location}}";$scope.results=[],$scope.active=!1,$scope.location=null,$scope.detectionAllowed=navigator.geolocation?!0:!1,$scope.radii=[{name:"1 mile",value:1},{name:"2 miles",value:2},{name:"5 miles",value:5},{name:"10 miles",value:10},{name:"25 miles",value:25}],$scope.radius=$scope.radii[3],$scope.setRadius=function(radius){$mundusMeus.setRadius(radius.value)},$scope.setGeolocation=function(data){$mundusMeus.setGeolocation(data),$mundusMeus.toLocation(data.latitude,data.longitude)},$scope.getGeolocation=function(name){var getResults=function(){var url=$scope.$eval($interpolate(URL_GEOLOCATE));$http.get(url).success(function(data){$scope.results=data,1===$scope.results.length&&($scope.setGeolocation($scope.results[0]),$timeout(function(){$mundusMeus.openSearchResults()},800))})};return"undefined"==typeof name?(navigator.geolocation.getCurrentPosition(function(position){$scope.location=position.coords.latitude+","+position.coords.longitude,$scope.$apply(),getResults()}),void 0):($scope.location=name,getResults(),void 0)}}function SearchCtrl($scope,$http,$interpolate,$mundusMeus){var URL_SEARCH="./../api/Search/{{position.latitude}}/{{position.longitude}}/{{radius}}";$scope.active=!1,$scope.results=[],$scope.radius=null,$scope.model={},$scope.position={latitude:null,longitude:null},$scope.isActive=function(model){return $scope.model===model},$scope.findMarker=function(model){$scope.model=model,$mundusMeus.highlightMarker(model),$mundusMeus.toLocation(model.latitude,model.longitude)},$scope.$on("radiusUpdated",function(context,radius){$scope.radius=radius}),$scope.$on("locationUpdated",function(context,data){$scope.position.latitude=data.latitude,$scope.position.longitude=data.longitude;var url=$scope.$eval($interpolate(URL_SEARCH));$http.get(url).success(function(data){$scope.results=data,$scope.display=!0,$mundusMeus.plotMarkers(data)})}),$scope.$on("displaySearchResults",function(){$scope.active=!0})}function MapCtrl(){}var app=angular.module("mundusMeusApp",[]);GeolocationCtrl.$inject=["$scope","$http","$interpolate","$timeout","$mundusMeus"],SearchCtrl.$inject=["$scope","$http","$interpolate","$mundusMeus"],MapCtrl.$inject=["$scope","$mundusMeus"],app.directive("map",["$mundusMeus",function(){var allMarkers=[];return{restrict:"E",link:function($scope,$element){var mapElement=$element[0],map=L.map(mapElement,{center:[51.505,-.09],zoom:13});L.tileLayer("http://b.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/102960/256/{z}/{x}/{y}.png").addTo(map),$scope.$on("highlightMarker",function(context,model){allMarkers.forEach(function(item){var classList=item.marker._icon.classList;return item.model===model?(classList.add("active"),void 0):(classList.remove("active"),void 0)})}),$scope.$on("positionUpdate",function(context,latitude,longitude){map.panTo(new L.LatLng(latitude,longitude))}),$scope.$on("plotMarkers",function(context,models){var latLongBounds=[];allMarkers.forEach(function(item){map.removeLayer(item.marker)}),allMarkers.length=0,models.forEach(function(model){var icon=L.divIcon({className:"marker-icon index-"+allMarkers.length,size:[100,100]}),marker=L.marker([model.latitude,model.longitude],{icon:icon}).addTo(map);allMarkers.push({model:model,marker:marker}),latLongBounds.push([model.latitude,model.longitude])}),map.fitBounds([latLongBounds])})}}}]),app.directive("findLocation",function(){return{restrict:"A",link:function($scope,$element){$element.bind("click",function(){$scope.active=!0,$scope.$apply()})}}}),app.directive("openLocationResults",["$mundusMeus",function($mundusMeus){return{restrict:"A",link:function($scope,$element){$element.bind("click",function(){$mundusMeus.openSearchResults()})}}}]),app.factory("$mundusMeus",function($rootScope){var service={};return service.setRadius=function(radius){$rootScope.$broadcast("radiusUpdated",radius)},service.setGeolocation=function(data){$rootScope.$broadcast("locationUpdated",data)},service.toLocation=function(latitude,longitude){$rootScope.$broadcast("positionUpdate",latitude,longitude)},service.openSearchResults=function(){$rootScope.$broadcast("displaySearchResults")},service.highlightMarker=function(model){$rootScope.$broadcast("highlightMarker",model)},service.plotMarkers=function(markers){$rootScope.$broadcast("plotMarkers",markers)},service});